<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>è´ªåƒè›‡</title>
    <style>
    .map{
        width: 800px;
        height: 600px;
        background-color: #ccc;
        position: relative;
    }
    </style>
</head>
<body>
    <div class="map"></div>
</body>
<script>
    
    // è‡ªè°ƒç”¨å‡½æ•°-->é£Ÿç‰©å¯¹è±¡
    (function (){
        // å­˜æ”¾é£Ÿç‰©
        var elements = [];
       
        remove();

        
        // é£Ÿç‰©çš„æ„é€ æ–¹æ³•
        function Food(x,y,width,height,color){
            // åæ ‡
            this.x = x || 0;
            this.y = y || 0;
            // é£Ÿç‰©çš„å¤§å°
            this.width = width || 20;
            this.height = height || 20;
            // é£Ÿç‰©é¢œè‰²
            this.color = color || "#555";
        }

        Food.prototype.init = function (map){ 
            // åˆ é™¤ä¹‹å‰çš„ğŸ
            remove();
            var food = document.createElement("div");
            map.appendChild(food);
            // è„±ç¦»æ–‡æ¡£æµ
            food.style.position = "absolute";
            // è®¾ç½®æ ·å¼
            food.style.width = this.width+"px";
            food.style.height = this.height+"px";
            food.style.backgroundColor = this.color;    //æ³¨æ„ï¼šæ˜¯backgroundColorï¼Œä¸æ˜¯color
            // ç”Ÿæˆå¹¶è®¾ç½®éšæœºåæ ‡
            // æ³¨æ„ï¼šoffsetWidthã€offsetHeightä¸­çš„sæ˜¯å°å†™
            this.x = parseInt(Math.random() * (map.offsetWidth / this.width)) * this.width;
            this.y = parseInt(Math.random() * (map.offsetHeight / this.height)) * this.height;
            food.style.left = this.x + "px";
            food.style.top =  this.y + "px";
            // åŠ å…¥åˆ°elementsæ•°ç»„ä¸­----ç›®çš„æ˜¯ä¸ºäº†åˆ é™¤
            elements.push(food);
        };

        // åˆ é™¤
        function remove(){
            if(elements.length>0){
                for(var i=elements.length-1;i>=0;i--){
                    elements[i].parentNode.removeChild(elements[i]);
                    elements.splice(i,1);   // æ³¨æ„ï¼šè¡¨ç¤ºåœ¨ç¬¬iä¸ªä½ç½®åˆ é™¤nä¸ªå…ƒç´ 
                } 
            }
        };
        window.Food = Food;

    }());

    // è‡ªè°ƒç”¨å‡½æ•°--> å°è›‡å¯¹è±¡
    (function(){
        var elements = [];
        //
        function Snake(width,height,direction){
            this.width = width || 20;
            this.height = height || 20;
            this.body = [
                {x:3,y:3,color:"red"},  //å¤´éƒ¨
                {x:2,y:3,color:"orange"},   // èº«ä½“
                {x:1,y:3,color:"orange"}    // èº«ä½“
            ];
            this.direction = direction || "right";
        };
        
        // åˆå§‹åŒ–å‡½æ•°
        Snake.prototype.init = function(map){
            // åˆ é™¤ä¹‹å‰çš„ğŸ
            remove();
            for(var i=0;i<this.body.length;i++){
                // åˆ›å»ºå…ƒç´ å¹¶æ·»åŠ åˆ°åœ°å›¾
                var div = document.createElement("div");
                map.appendChild(div);
                div.style.width = this.width+"px";
                div.style.height = this.height+"px";
                div.style.position= "absolute";
                div.style.left = this.body[i].x * this.width+"px" ;
                div.style.top = this.body[i].y * this.height+"px" ;
                div.style.backgroundColor = this.body[i].color;

                elements.push(div);
            }
        };
        
        // è›‡ç§»åŠ¨å‡½æ•°
        Snake.prototype.move = function(food,map){
            // èº«ä½“éƒ¨åˆ†éƒ½ä½¿ç”¨å‰ä¸€ä¸ªdivçš„åæ ‡
            for(var i=this.body.length-1;i>0;i--){
                this.body[i].x = this.body[i-1].x;
                this.body[i].y = this.body[i-1].y;
            }
            // æ”¹å˜ç§»åŠ¨æ–¹å‘
            switch(this.direction){
                case "left":
                    this.body[0].x -= 1;
                    break; 
                case "right" :
                    this.body[0].x += 1;
                    break; 
                case "top" :
                    this.body[0].y -= 1;
                    break; 
                case "bottom" :
                    this.body[0].y += 1;
                    break; 
            }

            // é£Ÿç‰©æ’å‡»æ£€æµ‹
            var headX = this.body[0].x * this.width;
            var headY = this.body[0].y * this.height;
            if(headX == food.x && headY == food.y){
                var lastBody = this.body[this.body.length-1];
                this.body.push({
                    x:lastBody.x,
                    y:lastBody.y,
                    color:lastBody.color
                });
                food.init(map);
            }


            // é‡æ–°ç»˜åˆ¶å°è›‡
            this.init(map);
        };
        // åˆ é™¤
        function remove(){
            if(elements.length>0){
                for(var i=elements.length-1;i>=0;i--){
                    elements[i].parentNode.removeChild(elements[i]);
                    elements.splice(i,1);   // æ³¨æ„ï¼šè¡¨ç¤ºåœ¨ç¬¬iä¸ªä½ç½®åˆ é™¤nä¸ªå…ƒç´ 
                } 
            }
        };
        window.Snake = Snake;
    }());

    // è‡ªè°ƒç”¨å‡½æ•°--> æ¸¸æˆå¯¹è±¡
    (function(){
        function Game(map){
            this.food = new Food();
            this.snake = new Snake();
            this.map = map;
            that = this;
        };

        Game.prototype.init = function(){
            this.food.init(this.map);
            this.snake.init(this.map);
            this.autoMove(this.food,this.map);
            this.bindKey();
        };

        // å°è›‡è‡ªåŠ¨ç§»åŠ¨
        Game.prototype.autoMove = function(food,map){
            var timeId = setInterval(function(){
                this.snake.move(food,map);
                
                // è¾¹ç•Œæ’å‡»æ£€æµ‹
                var borderRight = map.offsetWidth / this.snake.width ;
                var borderBottom = map.offsetHeight / this.snake.height ;
                if(this.snake.body[0].x<0 || this.snake.body[0].x> borderRight-1 ||
                    this.snake.body[0].y<0 || this.snake.body[0].y> borderBottom-1  ){
                    clearInterval(timeId);
                    alert("GG!");
                }
            }.bind(that),200);
        };

        //
        Game.prototype.bindKey = function(){
            document.addEventListener("keydown",function(e){
                console.log("æŒ‰é”®æŒ‰ä¸‹");
                switch(e.keyCode){
                    case 37:this.snake.direction="left";break;
                    case 38:this.snake.direction="top";break;
                    case 39:this.snake.direction="right";break;
                    case 40:this.snake.direction="bottom";break;
                }
            }.bind(that),false);
        };

        window.Game = Game;

    }());
    // æµ‹è¯•ä»£ç 
    // var food = new Food();
    // var snake = new Snake();
    // food.init(document.querySelector(".map"));
    // snake.init(document.querySelector(".map"));
    // snake.move(food,document.querySelector(".map"))
    // snake.init(document.querySelector(".map"));
    var game = new Game(document.querySelector(".map"));
    game.init();
</script>
</html>